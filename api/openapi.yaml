openapi: 3.0.3
info:
  title: Nonce Auth API
  description: Open-source Authentication Backend-as-a-Service (Auth BaaS). Multi-tenant, project-scoped auth.
  version: 0.1.0
  license:
    name: Apache-2.0

servers:
  - url: http://localhost:8080/v1
    description: Local (API base path /v1)

paths:
  /health:
    get:
      summary: Health check
      description: Returns service and dependency health (database, optional Redis).
      operationId: getHealth
      tags: [System]
      responses:
        "200":
          description: All checks ok
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
        "503":
          description: One or more checks failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /auth/signup:
    post:
      summary: Register user
      description: Create a new user for the project. Requires project API key.
      operationId: signup
      tags: [Auth]
      security:
        - ProjectKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SignupRequest"
      responses:
        "201":
          description: User created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          description: User already exists for this project
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /auth/login:
    post:
      summary: Login
      description: Authenticate with email and password. Returns access and refresh tokens.
      operationId: login
      tags: [Auth]
      security:
        - ProjectKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /auth/refresh:
    post:
      summary: Refresh tokens
      description: Exchange a valid refresh token for a new access token and optionally a new refresh token.
      operationId: refresh
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RefreshRequest"
      responses:
        "200":
          description: New tokens
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RefreshResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /auth/logout:
    post:
      summary: Logout
      description: Revoke refresh token (optional body). Returns 204.
      operationId: logout
      tags: [Auth]
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                refresh_token:
                  type: string
      responses:
        "204":
          description: No content

  /auth/switch-org:
    post:
      summary: Switch organization context
      description: Issue a new access token with org_id and role so subsequent requests are org-scoped. Requires JWT.
      operationId: switchOrg
      tags: [Auth]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SwitchOrgRequest"
      responses:
        "200":
          description: New access token with org context
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SwitchOrgResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Not a member of this organization

  /organizations:
    get:
      summary: List organizations
      description: Returns organizations the current user is a member of. Requires JWT.
      operationId: listOrganizations
      tags: [Organizations]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: List of organizations
          content:
            application/json:
              schema:
                type: object
                properties:
                  organizations:
                    type: array
                    items:
                      $ref: "#/components/schemas/OrgResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
    post:
      summary: Create organization
      description: Create a new organization; creator becomes owner. Requires JWT.
      operationId: createOrganization
      tags: [Organizations]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateOrgRequest"
      responses:
        "201":
          description: Organization created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrgResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /organizations/{id}:
    get:
      summary: Get organization
      description: Get organization by ID. Requires JWT; user must be a member.
      operationId: getOrganization
      tags: [Organizations]
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Organization
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrgResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Organization not found
    patch:
      summary: Update organization name
      description: Update organization name. Requires JWT; user must be owner or admin.
      operationId: updateOrganization
      tags: [Organizations]
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  maxLength: 255
      responses:
        "200":
          description: Updated
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Forbidden (requires owner or admin)

  /organizations/{id}/members:
    get:
      summary: List organization members
      description: List members of the organization. Requires JWT; user must be a member.
      operationId: listOrgMembers
      tags: [Organizations]
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: List of members
          content:
            application/json:
              schema:
                type: object
                properties:
                  members:
                    type: array
                    items:
                      $ref: "#/components/schemas/MemberResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Organization not found
    post:
      summary: Add organization member
      description: Add a user to the organization with a role. Requires JWT; user must be owner or admin.
      operationId: addOrgMember
      tags: [Organizations]
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user_id, role]
              properties:
                user_id:
                  type: string
                  format: uuid
                role:
                  type: string
                  enum: [owner, admin, member]
      responses:
        "201":
          description: Member added
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Forbidden (requires owner or admin)

  /organizations/{id}/members/{user_id}:
    delete:
      summary: Remove organization member
      description: Remove a user from the organization. Requires JWT; user must be owner or admin.
      operationId: removeOrgMember
      tags: [Organizations]
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Member removed
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Forbidden (requires owner or admin)

  /users/me:
    get:
      summary: Get current user
      description: Returns the authenticated user (from JWT). Requires JWT.
      operationId: getMe
      tags: [Users]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Current user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MeResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: User not found
    patch:
      summary: Update current user
      description: Update current user profile (e.g. email, user_metadata). Requires JWT.
      operationId: updateMe
      tags: [Users]
      security:
        - BearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                user_metadata:
                  type: object
      responses:
        "200":
          description: Updated
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
    delete:
      summary: Delete current user (GDPR)
      description: Soft-delete the current user and revoke all sessions. Requires JWT.
      operationId: deleteMe
      tags: [Users]
      security:
        - BearerAuth: []
      responses:
        "204":
          description: User deleted
        "401":
          $ref: "#/components/responses/Unauthorized"

  /users/me/export:
    get:
      summary: Export current user data (GDPR)
      description: Returns the current user's data for data portability. Requires JWT.
      operationId: exportMe
      tags: [Users]
      security:
        - BearerAuth: []
      responses:
        "200":
          description: User data export
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExportMeResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

components:
  securitySchemes:
    ProjectKey:
      type: apiKey
      in: header
      name: X-Nonce-Project-Key
      description: Project API key (or Authorization Bearer with project key)
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Access token for protected routes

  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok, unhealthy]
        checks:
          type: object
          additionalProperties:
            type: string
        message:
          type: string

    SignupRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
          maxLength: 254
        password:
          type: string
          minLength: 8
          maxLength: 128

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
          maxLength: 254
        password:
          type: string
          maxLength: 128

    RefreshRequest:
      type: object
      required: [refresh_token]
      properties:
        refresh_token:
          type: string
          maxLength: 1024

    UserResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        project_id:
          type: string
          format: uuid
        email:
          type: string
        created_at:
          type: string
          format: date-time

    LoginResponse:
      type: object
      properties:
        access_token:
          type: string
        refresh_token:
          type: string
        expires_in:
          type: integer
          description: Access token TTL in seconds
        user:
          type: object
          properties:
            id:
              type: string
              format: uuid
            email:
              type: string

    RefreshResponse:
      type: object
      properties:
        access_token:
          type: string
        refresh_token:
          type: string
        expires_in:
          type: integer

    SwitchOrgRequest:
      type: object
      required: [organization_id]
      properties:
        organization_id:
          type: string
          format: uuid

    SwitchOrgResponse:
      type: object
      properties:
        access_token:
          type: string
        expires_in:
          type: integer
        org_id:
          type: string
          format: uuid
        role:
          type: string

    OrgResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        project_id:
          type: string
          format: uuid
        name:
          type: string
        created_at:
          type: string
          format: date-time

    CreateOrgRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
          maxLength: 255

    MemberResponse:
      type: object
      properties:
        user_id:
          type: string
          format: uuid
        role:
          type: string
        created_at:
          type: string
          format: date-time

    MeResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        project_id:
          type: string
          format: uuid
        email:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        email_verified_at:
          type: string
          format: date-time
          nullable: true
        anonymous:
          type: boolean
        user_metadata:
          type: object
        app_metadata:
          type: object

    ExportMeResponse:
      type: object
      properties:
        exported_at:
          type: string
          format: date-time
        data:
          $ref: "#/components/schemas/MeResponse"

    Error:
      type: object
      properties:
        error:
          type: string

  responses:
    BadRequest:
      description: Invalid request body or validation error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    Unauthorized:
      description: Missing or invalid project key / credentials
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
